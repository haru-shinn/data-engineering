# ロストアップデート（更新消失）実験

## 検証内容

銀行口座の残高（1,000円）に対して、100人が同時に1円ずつ入金を行ったときに、正しく1,100円となるか。

### 比較検証

悲観的ロック「誰かが同時に更新してくるから、先に鍵をかけてしまおう」という考え方。
楽観的ロック「たぶん誰も更新してこないだろう。もし更新されてたら、その時だけやり直そう」という考え方。

## 準備

高負荷の作り方: 100並列（100接続）で一斉に UPDATE をかける。

## ポイント

- FOR UPDATE（行ロック）なしだと、計算が合わなくなる現象を体験する。
- トランザクションの分離レベル（Read Committed vs Serializable）による挙動の違い。
- ロック待ちによるパフォーマンス低下（待ち行列）の観測。

## 準備ログ

```bash
# フォルダ移動
$ cd sql_lab/lost_update

# コンテナの起動
$ docker compose up -d
[+] up 17/17
 ✔ Image postgres:16        Pulled                                                                                    911.3s 
 ✔ Network lost_update_default Created                                                                                  0.0s 
 ✔ Container postgres_container Created                                                                                 0.6s 
Error response from daemon: failed to set up container networking: driver failed programming external connectivity on endpoint postgres_container (9b8fe75984f587b43c8fa7f2de3e5b04f460b09219e32bcf9ffe126b85a6f45d): failed to bind host port 0.0.0.0:5432/tcp: address already in use

# portの確認
$ sudo netstat -plnt | grep postgres
[sudo] password for yfukudome: 
tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      293/postgres        
tcp6       0      0 :::5432                 :::*                    LISTEN      293/postgres   

# portの変更
# docker-compose.yml内で、WSL2側のport番号を変更（コンテナ側は5432のまま）

# 再度起動
$ docker compose up -d
[+] up 1/1
 ✔ Container postgres_container Recreated

# DBへの接続
$ psql -h localhost -p 5433 -U user -d training_db
psql: error: connection to server at "localhost" (127.0.0.1), port 5433 failed: Connection refused

# コンテナが起動しているかの確認
$ ocker ps -a
CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS                     PORTS     NAMES
189e7270bbbf   postgres:16   "docker-entrypoint.s…"   2 minutes ago   Exited (3) 2 minutes ago             postgres_container


# コンテナの起動ログ
$ docker logs postgres_container
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.utf8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/data ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.
syncing data to disk ... ok


Success. You can now start the database server using:

    pg_ctl -D /var/lib/postgresql/data -l logfile start

waiting for server to start....2026-01-27 11:58:43.760 UTC [49] LOG:  starting PostgreSQL 16.11 (Debian 16.11-1.pgdg13+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 14.2.0-19) 14.2.0, 64-bit
2026-01-27 11:58:43.764 UTC [49] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2026-01-27 11:58:43.771 UTC [52] LOG:  database system was shut down at 2026-01-27 11:58:43 UTC
2026-01-27 11:58:43.777 UTC [49] LOG:  database system is ready to accept connections
 done
server started
CREATE DATABASE


/usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/ddl.sql
psql:/docker-entrypoint-initdb.d/ddl.sql:6: ERROR:  database "training_db" already exists
2026-01-27 11:58:44.035 UTC [62] ERROR:  database "training_db" already exists
2026-01-27 11:58:44.035 UTC [62] STATEMENT:  /*
        データベースの初期化
        */
        -- DB作成
        CREATE DATABASE training_db;


# コンテナ停止 ＆ ボリューム（データ）を完全に削除
$ docker compose down -v
[+] down 2/2
 ✔ Container postgres_container Removed                                                                                  0.0s 
 ✔ Network lost_update_default  Removed 

# ローカルの pgdata フォルダの削除
$ sudo rm -rf ./pgdata

# ddl.sql内で　CREATE DATABASE xxx をコメントアウト

# コンテナの再起動
docker compose up -d
[+] up 2/2
 ✔ Network lost_update_default  Created

# コンテナの中に入って確認
docker exec -it postgres_container psql -U test-user -d training_db -c "\dt"
Password for user test-user: 
            List of relations
 Schema |    Name    | Type  |   Owner   
--------+------------+-------+-----------
 public | sample_tbl | table | test-user
(1 row)

```

## ログイン方法

```bash
psql -h localhost -p 5433 -U test-user -d training_db
```

## コマンド

```sql
-- 10人が一斉にUpdateを実行する
pgbench -h localhost -p 5433 -U test-user -d training_db -c 10 -t 10 -f update_balance.sql
-- 結果確認
psql -h localhost -p 5433 -U test-user -d training_db -c "SELECT * FROM sample_tbl WHERE id = 'c4ca4238_000001';"
```

## シナリオ用実行のログ

### 悲観的ロック

#### 他の人の更新を許可したVer

```bash
# update_balance.sqlのUpdate文の場合、PostgreSQLはアトミック（不可分）な更新をしている。
## ウインドウA
training_db=# select * from sample_tbl limit 3;
       id        | balance |  created_date_time  
-----------------+---------+---------------------
 c4ca4238_000001 |    7102 | 2026-10-17 00:00:00
 c81e728d_000002 |    7374 | 2026-12-02 00:00:00
 eccbc87e_000003 |    4013 | 2026-12-29 00:00:00
(3 rows)

training_db=# BEGIN;
BEGIN
training_db=*# select balance from sample_tbl where id = 'c4ca4238_000001';
 balance 
---------
    7102
(1 row)

training_db=*# update sample_tbl set balance = balance + 1 where id = 'c4ca4238_000001';
UPDATE 1
training_db=*# commit;
COMMIT
training_db=# select balance from sample_tbl where id = 'c4ca4238_000001';
 balance 
---------
    7103
(1 row)

### (ウインドウBで100回Updateを実行 ※commit前にウインドウBでUpdateした場合でも更新される)

training_db=# select balance from sample_tbl where id = 'c4ca4238_000001';
 balance 
---------
    7203
(1 row)

training_db=# update sample_tbl set balance = 7103 where id = 'c4ca4238_000001';
UPDATE 1
training_db=# commit;
WARNING:  there is no transaction in progress
COMMIT
training_db=# 

## ウインドウB
$ pgbench -h localhost -p 5433 -U test-user -d training_db -c 10 -t 10 -f update_balance.sql
est-user -d training_db -c 10 -t 10 -f update_balance.sql
Password:
pgbench (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1))
(略)
transaction type: update_balance.sql
scaling factor: 1
query mode: simple
number of clients: 10
number of threads: 1
maximum number of tries: 1
number of transactions per client: 10
number of transactions actually processed: 100/100
number of failed transactions: 0 (0.000%)
latency average = 18.879 ms
initial connection time = 73.523 ms
tps = 529.697490 (without initial connection time)

$ psql -h localhost -p 5433 -U test-user -d training_db -c "SELECT * FROM sample_tbl WHERE id = 'c4ca4238_000001';"
Password for user test-user:
       id        | balance |  created_date_time
-----------------+---------+---------------------
 c4ca4238_000001 |    7203 | 2026-10-17 00:00:00
(1 row)

### (ウインドウAで7203→7103へ変更)

$ psql -h localhost -p 5433 -U test-user -d training_db -c "SELECT * FROM sample_tbl WHERE id = 'c4ca4238_000001';"
Password for user test-user:
       id        | balance |  created_date_time
-----------------+---------+---------------------
 c4ca4238_000001 |    7103 | 2026-10-17 00:00:00
(1 row)
```

#### 他の人の更新を許可しないVer

```bash
# ロック待ち
## ウインドウA
training_db=# select * from sample_tbl where id = 'c4ca4238_000001';
       id        | balance |  created_date_time  
-----------------+---------+---------------------
 c4ca4238_000001 |    7103 | 2026-10-17 00:00:00
(1 row)

training_db=# begin;
BEGIN
training_db=*# select balance from sample_tbl where id = 'c4ca4238_000001' for update;
 balance 
---------
    7103
(1 row)

training_db=*# update sample_tbl set balance = 7203 where id = 'c4ca4238_000001';
UPDATE 1
training_db=*# select balance from sample_tbl where id = 'c4ca4238_000001' for update;
 balance 
---------
    7203
(1 row)

### (ウインドウBでUpdate, ただし、ロックかかっている)

training_db=*# commit;
COMMIT

### (ウインドウBのUpdateが実行される)

training_db=# select balance from sample_tbl where id = 'c4ca4238_000001' for update;
 balance 
---------
    7303
(1 row)

training_db=# 

## ウインドウB

### （ウインドウAでcommit後に実行される）
$ pgbench -h localhost -p 5433 -U test-user -d training_db -c 10 -t 10 -f update_balance.sql
Password:
pgbench (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1))
pgbench: pghost: localhost pgport: 5433 nclients: 10 nxacts: 10 dbName: training_db
starting vacuum...pgbench: error: ERROR:  relation "pgbench_branches" does not exist
pgbench: detail: (ignoring this error and continuing anyway)
pgbench: error: ERROR:  relation "pgbench_tellers" does not exist
pgbench: detail: (ignoring this error and continuing anyway)
pgbench: error: ERROR:  relation "pgbench_history" does not exist
pgbench: detail: (ignoring this error and continuing anyway)
end.
pgbench: client 0 executing script "update_balance.sql"
pgbench: client 0 sending BEGIN;
(略)
transaction type: update_balance.sql
scaling factor: 1
query mode: simple
number of clients: 10
number of threads: 1
maximum number of tries: 1
number of transactions per client: 10
number of transactions actually processed: 100/100
number of failed transactions: 0 (0.000%)
latency average = 7637.589 ms
initial connection time = 88.533 ms
tps = 1.309314 (without initial connection time)

```

#### 実行結果の比較

|比較項目|for updateなし|for updateあり|
|--|--|--|
|latency average|18.879 ms|7637.589 ms|
|initial connection time|73.523 ms|88.533 ms|
|tps|529.697490|1.309314|

処理速度 (tps): 約 530件/秒 → 約 1.3件/秒 （約 400倍 の性能劣化）
応答時間 (latency): 約 19ms → 約 7637ms (7.6秒) （約 400倍 の待ち時間）

### 楽観的ロック

```bash
# ウインドウA
$ psql -h localhost -p 5433 -U test-user -d training_db
Password for user test-user: 
psql (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1))
Type "help" for help.

training_db=# select * from sample_tbl_2 limit 2;
       id        | balance |  created_date_time  | version 
-----------------+---------+---------------------+---------
 c4ca4238_100001 |    3803 | 2027-01-07 00:00:00 |       1
 c81e728d_100002 |    1989 | 2026-03-28 00:00:00 |       1
(2 rows)

## (ウインドウBでoptimistic.sqlを実行)

training_db=# select * from sample_tbl_2 where id = 'c4ca4238_100001';
       id        | balance |  created_date_time  | version 
-----------------+---------+---------------------+---------
 c4ca4238_100001 |    3804 | 2027-01-07 00:00:00 |       2
(1 row)

training_db=# 


# ウインドウB
pgbench -h localhost -p 5433 -U test-user -d training_db -c 10 -t 10 -f optimistic.sql
Password:
pgbench (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1))
pgbench: pghost: localhost pgport: 5433 nclients: 10 nxacts: 10 dbName: training_db
starting vacuum...pgbench: error: ERROR:  relation "pgbench_branches" does not exist
pgbench: detail: (ignoring this error and continuing anyway)
pgbench: error: ERROR:  relation "pgbench_tellers" does not exist
pgbench: detail: (ignoring this error and continuing anyway)
pgbench: error: ERROR:  relation "pgbench_history" does not exist
pgbench: detail: (ignoring this error and continuing anyway)
end.
pgbench: client 0 executing script "optimistic.sql"

transaction type: optimistic.sql
scaling factor: 1
query mode: simple
number of clients: 10
number of threads: 1
maximum number of tries: 1
number of transactions per client: 10
number of transactions actually processed: 100/100
number of failed transactions: 0 (0.000%)
latency average = 6.582 ms
initial connection time = 80.286 ms
tps = 1519.387383 (without initial connection time)

```
