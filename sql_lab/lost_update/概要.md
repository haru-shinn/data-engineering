# ロストアップデート（更新消失）実験

## 検証内容

「ある商品の在庫を1つ減らす」という処理を、同時に100人が行ったときに、在庫が正しく「-100」されるか。

## 準備

高負荷の作り方: 100並列（100接続）で一斉に UPDATE をかける。

## ポイント

- FOR UPDATE（行ロック）なしだと、計算が合わなくなる現象を体験する。
- トランザクションの分離レベル（Read Committed vs Serializable）による挙動の違い。
- ロック待ちによるパフォーマンス低下（待ち行列）の観測。

## 準備ログ

```bash
# フォルダ移動
$ cd sql_lab/lost_update

# コンテナの起動
$ docker compose up -d
[+] up 17/17
 ✔ Image postgres:16        Pulled                                                                                    911.3s 
 ✔ Network lost_update_default Created                                                                                  0.0s 
 ✔ Container postgres_container Created                                                                                 0.6s 
Error response from daemon: failed to set up container networking: driver failed programming external connectivity on endpoint postgres_container (9b8fe75984f587b43c8fa7f2de3e5b04f460b09219e32bcf9ffe126b85a6f45d): failed to bind host port 0.0.0.0:5432/tcp: address already in use

# portの確認
$ sudo netstat -plnt | grep postgres
[sudo] password for yfukudome: 
tcp        0      0 0.0.0.0:5432            0.0.0.0:*               LISTEN      293/postgres        
tcp6       0      0 :::5432                 :::*                    LISTEN      293/postgres   

# portの変更
# docker-compose.yml内で、WSL2側のport番号を変更（コンテナ側は5432のまま）

# 再度起動
$ docker compose up -d
[+] up 1/1
 ✔ Container postgres_container Recreated

# DBへの接続
$ psql -h localhost -p 5433 -U user -d training_db
psql: error: connection to server at "localhost" (127.0.0.1), port 5433 failed: Connection refused

# コンテナが起動しているかの確認
$ ocker ps -a
CONTAINER ID   IMAGE         COMMAND                  CREATED         STATUS                     PORTS     NAMES
189e7270bbbf   postgres:16   "docker-entrypoint.s…"   2 minutes ago   Exited (3) 2 minutes ago             postgres_container


# コンテナの起動ログ
$ docker logs postgres_container
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.utf8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/data ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
initdb: warning: enabling "trust" authentication for local connections
initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next time you run initdb.
syncing data to disk ... ok


Success. You can now start the database server using:

    pg_ctl -D /var/lib/postgresql/data -l logfile start

waiting for server to start....2026-01-27 11:58:43.760 UTC [49] LOG:  starting PostgreSQL 16.11 (Debian 16.11-1.pgdg13+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 14.2.0-19) 14.2.0, 64-bit
2026-01-27 11:58:43.764 UTC [49] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2026-01-27 11:58:43.771 UTC [52] LOG:  database system was shut down at 2026-01-27 11:58:43 UTC
2026-01-27 11:58:43.777 UTC [49] LOG:  database system is ready to accept connections
 done
server started
CREATE DATABASE


/usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/ddl.sql
psql:/docker-entrypoint-initdb.d/ddl.sql:6: ERROR:  database "training_db" already exists
2026-01-27 11:58:44.035 UTC [62] ERROR:  database "training_db" already exists
2026-01-27 11:58:44.035 UTC [62] STATEMENT:  /*
        データベースの初期化
        */
        -- DB作成
        CREATE DATABASE training_db;


# コンテナ停止 ＆ ボリューム（データ）を完全に削除
$ docker compose down -v
[+] down 2/2
 ✔ Container postgres_container Removed                                                                                  0.0s 
 ✔ Network lost_update_default  Removed 

# ローカルの pgdata フォルダの削除
$ sudo rm -rf ./pgdata

# ddl.sql内で　CREATE DATABASE xxx をコメントアウト

# コンテナの再起動
docker compose up -d
[+] up 2/2
 ✔ Network lost_update_default  Created

# コンテナの中に入って確認
docker exec -it postgres_container psql -U user -d training_db -c "\dt"
Password for user test-user: 
            List of relations
 Schema |    Name    | Type  |   Owner   
--------+------------+-------+-----------
 public | sample_tbl | table | test-user
(1 row)

```
