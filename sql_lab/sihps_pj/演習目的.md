# 長距離運航フェリー予約管理システムの構築

## 目的

業務でデータ基盤の運用やデータ利活用を行っている。
しかし、ソース元である基幹システムのデータベース設計は行ったことがない。
技術や業務レベル向上のため、基幹システムにおけるデータベース設計の演習を行う。

## 題材

フェリー動画を見ることが多いかつ、業務でフェリーではないが予約系のデータを見ることが多い。そのため、フェリーの予約管理システムを構築をテーマとする。

## ゴール

- フェリー予約エンジンの「完全ブラックボックス化」
  - SQLクライアントツールからSQLを実行することで、複雑な予約業務のすべてが正確に実行される状態を目指す。

- 【初級ゴール】整合性を保つ「堅牢なER図」の完成
  - 制約: `CHECK` 制約（子供運賃は大人の運賃より安い）や `UNIQUE` 制約を適切に設定することができる。
  - インデックス設計: 予約が増えても「空席照会」が重くならないよう度のカラムにインデックスを貼るべきか選定することができる。

- 【中級ゴール】SQLによる「業務ロジック」の実装
  - 空席判定クエリ: 「A地点からC地点まで、直通便かつ指定の部屋とバイク枠が空いているか？」を１つの `SELECT` 文で判定することができる。
  - 売上集計ビュー: 航路別、船別、日付別の乗船率や売上合計を算出することができる。
  - 2区間予約の自動展開: 1つの「予約」を、システム側で自動的に2つの「明細（区間1と2）」に分割して在庫を減らすロジックを実装できる。

- 【上級ゴール（最終目標）】ストアドプロシージャによる「予約API」の作成
  - トランザクション管理: 「部屋は確保できたが、バイク枠が埋まっていた」場合に、すべてを白紙に戻す（ロールバック）処理を実装することができる。
  - 在庫の同時実行制御（排他制御）: 同時に100人が最後の1室を狙って予約しても、決してオーバーブック（二重予約）させない仕組みを実装することができる。

- アウトプット
  - ER図: 全テーブルの定義とリレーションが網羅されたドキュメント。
  - SQL関数: 検索条件を入れると「予約可能な船の一覧」を返すSQL関数。
  - 代表者情報と人数、車種、希望の船を入れると、「予約・明細・在庫の更新」を矛盾なく実行するSQLスクリプト。

## ステップ

- 基礎構築
  - 必要なテーブルの洗い出し
  - 各テーブルのDDLの作成
  - 各テーブルへのデータ挿入（初期在庫の生成）
学び: テーブル間の参照整合性や型の使い分け

- 参照系ロジックの作成
  - 空席照会ビューの作成（`schedule`, `inventry` を結合して残数を計算し、空いている便を抽出）
  - 複雑な条件のクエリ
    - 2区間またがる在庫のチェック（新門司→苫小牧）するSQL
    - 「大人２名、車１台」といった両方の枠があるか判定するSQL

- 更新系ロジックの作成
  - 予約実行プロシージャの作成
    - 予約処理を行った際に、在庫を減らす。途中で失敗した際に、すべて元に戻るように実装する。
    - 残り一室の場合に、複数名が同時に予約できないようにロックをかけるように実装する。
