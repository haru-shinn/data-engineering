# 手順とコマンド

## 準備（ユーザの作成）

```bash
# テストユーザの作成
# ルートユーザでログイン
docker exec -it -u root 642e764eae2f /bin/bash
# Linux用ユーザの作成
adduser postgres_test_1
adduser postgres_test_2

# postgresユーザで再ログイン
docker container attach 642e764eae2f
psql -d postgres -U postgres
create user usera;
create user userb;

# 別ウインドウ1でログイン
docker exec -it -u testa
# 別ウインドウ2でログイン
docker exec -it -u testb
```

## 準備（設定の変更）

```bash
# 現状の確認(最大接続数)
postgres@642e764eae2f:/$ grep "max_connections" /var/lib/postgresql/16/main/postgresql.conf
max_connections = 100

# 現状の確認(スーパーユーザの予約枠)
postgres@642e764eae2f:/$ grep "superuser_reserved_connections" /var/lib/postgresql/16/main/postgresql.conf
#superuser_reserved_connections = 3     # (change requires restart)

# 最大接続数の変更
postgres@642e764eae2f:/$ sed -i.bak 's/^max_connections = .*/max_connections = 4/' /var/lib/postgresql/16/main/postgresql.conf

# 変更の確認
postgres@642e764eae2f:/$ grep "max_connections" /var/lib/postgresql/16/main/postgresql.conf
max_connections = 4
```

## 想定外の失敗

```bash
# メインウインドウ
# postgresqユーザでログイン
psql -d postgres -U postgres

# 別ウインドウ1
# testaユーザでログイン
psql -d postgres -U testa
postgres_test_1@642e764eae2f:/$ psql -d postgres -U testa
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  remaining connection slots are reserved for roles with the SUPERUSER attribute

# メインウインドウ
# pid=205がバックグランドでログインしていた。
# max_connections=4, superuser_reserved_connections=3, あまり=1
# pid=211は一般ユーザ枠でログインしていた。。
postgres=# SELECT pid, usename, application_name, client_addr, backend_start 
FROM pg_stat_activity;
 pid | usename  | application_name | client_addr |         backend_start         
-----+----------+------------------+-------------+-------------------------------
 204 |          |                  |             | 2026-02-05 21:31:38.521273+00
 205 | postgres |                  |             | 2026-02-05 21:31:38.521592+00
 211 | postgres | psql             |             | 2026-02-05 21:34:52.163891+00
 201 |          |                  |             | 2026-02-05 21:31:38.50758+00
 200 |          |                  |             | 2026-02-05 21:31:38.507261+00
 203 |          |                  |             | 2026-02-05 21:31:38.520981+00
(6 rows)

```

## 再度Try

```bash
# 別ウインドウ1
# testaユーザが先にログイン
postgres_test_1@642e764eae2f:/$ psql -U testa -d postgres
psql (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1))
Type "help" for help.

# メインウインドウ
# スーパーユーザ枠としてログイン
postgres@642e764eae2f:/$ psql -d postgres -U postgres
psql (16.11 (Ubuntu 16.11-0ubuntu0.24.04.1))
Type "help" for help.

# 別ウインドウ2
# 想定通り失敗
postgres_test_2@642e764eae2f:/$ psql -d postgres -U testb
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  remaining connection slots are reserved for roles with the SUPERUSER attribute
postgres_test_2@642e764eae2f:/$

# メインウインドウ
# ログイン状況
postgres=# SELECT pid, usename, application_name, client_addr, backend_start 
FROM pg_stat_activity;
 pid | usename  | application_name | client_addr |         backend_start         
-----+----------+------------------+-------------+-------------------------------
 204 |          |                  |             | 2026-02-05 21:31:38.521273+00
 205 | postgres |                  |             | 2026-02-05 21:31:38.521592+00
 222 | testa    | psql             |             | 2026-02-05 21:40:18.819949+00
 227 | postgres | psql             |             | 2026-02-05 21:40:43.699321+00
 201 |          |                  |             | 2026-02-05 21:31:38.50758+00
 200 |          |                  |             | 2026-02-05 21:31:38.507261+00
 203 |          |                  |             | 2026-02-05 21:31:38.520981+00
(7 rows)
```

## 一般ユーザの追い出し

```bash
# メインウインドウ
postgres=# select pg_terminate_backend(222);
 pg_terminate_backend 
----------------------
 t
(1 row)

postgres=# 2026-02-05 21:42:15.680 UTC [222] FATAL:  terminating connection due to administrator command
                                 
postgres=# SELECT pid, usename, application_name, client_addr, backend_start 
FROM pg_stat_activity;
 pid | usename  | application_name | client_addr |         backend_start         
-----+----------+------------------+-------------+-------------------------------
 204 |          |                  |             | 2026-02-05 21:31:38.521273+00
 205 | postgres |                  |             | 2026-02-05 21:31:38.521592+00
 227 | postgres | psql             |             | 2026-02-05 21:40:43.699321+00
 201 |          |                  |             | 2026-02-05 21:31:38.50758+00
 200 |          |                  |             | 2026-02-05 21:31:38.507261+00
 203 |          |                  |             | 2026-02-05 21:31:38.520981+00
(6 rows)

# 別ウインドウ2
# postgresの席がスーパーユーザ枠から一般ユーザ枠に移ってログイン失敗
# 「一般ユーザーがログインできないこと」よりも「管理者がログインできないこと」の方がはるかに重大なリスクらしい。
postgres_test_2@642e764eae2f:/$ psql -d postgres -U testb
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  remaining connection slots are reserved for roles with the SUPERUSER attribute
```

## 戻し作業

```bash
# 現状の確認(最大接続数)
postgres@642e764eae2f:/$ grep "max_connections" /var/lib/postgresql/16/main/postgresql.conf
max_connections = 4

# 現状の確認(スーパーユーザの予約枠)
postgres@642e764eae2f:/$ grep "superuser_reserved_connections" /var/lib/postgresql/16/main/postgresql.conf
#superuser_reserved_connections = 3     # (change requires restart)

# 最大接続数の変更
postgres@642e764eae2f:/$ sed -i.bak 's/^max_connections = .*/max_connections = 100/' /var/lib/postgresql/16/main/postgresql.conf

# 変更の確認
postgres@642e764eae2f:/$ grep "max_connections" /var/lib/postgresql/16/main/postgresql.conf
max_connections = 100
```
