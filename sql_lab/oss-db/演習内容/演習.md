# 演習

## 演習1：PITR（ポイントインタイムリカバリ）の実践

**【重要度：7 / カテゴリ：S2.4 バックアップ方法】**

「間違えて大事なデータを削除してしまった！」という状況を想定し、WAL（ログ）を使って特定の時刻の状態に戻す演習です。

### シナリオ（RITR）

- **準備**: `postgresql.conf` で `archive_mode = on` にし、`archive_command` を設定して再起動します。
- **ベースライン**: `pg_basebackup` を使用して、フルバックアップを取得します。
- **作業**: データベースにログインし、テーブルにデータを数件挿入します。この時の**時刻**をメモしてください。
- **事故発生**: `DELETE` 文または `DROP TABLE` でデータを消去します。
- **復旧**:
  - PostgreSQLを停止します。
  - データディレクトリを退避し、手順2のバックアップを書き戻します。
  - データディレクトリ直下に `recovery.signal` ファイル（空ファイル）を作成します。
  - `postgresql.conf` に `recovery_target_time`（メモした時刻）を記述します。
- **確認**: サーバを起動し、消したはずのデータが戻っているか確認します。

```bash
Bash
# 1. 設定ファイルの場所を確認
psql -c "show config_file;"

# 2. vimなどで設定を変更（例: /etc/postgresql/14/main/postgresql.conf）
# 以下の項目を探して変更してください
# archive_mode = on
# archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
# wal_level = replica

# 3. アーカイブディレクトリの作成
mkdir -p /var/lib/postgresql/archive

# 4. 設定反映（再起動が必要なパラメータです）
pg_ctl restart -D /var/lib/postgresql/14/main
```

---

## 演習2：VACUUMの効果と肥大化（Bloat）の確認

**【重要度：7 / カテゴリ：S2.5 基本的な運用管理作業】**

PostgreSQL特有の「不要領域（ゴミ）」がどのように発生し、VACUUMでどう処理されるかを理解する演習です。

### シナリオ（VACCUM）

- **準備**: 大量のテストデータ（1万件程度）を持つテーブルを作成します。
  - `SELECT pg_relation_size('テーブル名');` で現在のサイズを確認します。
- **更新**: `UPDATE` 文ですべての行の値を書き換えます。
  - PostgreSQLは「古い行に削除フラグを立て、新しい行を追加」するため、この時点でデータ量は約2倍に増えています。
- **確認（不要領域）**: `pg_stat_user_tables` ビューを参照し、`n_dead_tup`（死んだタプル数）が増えていることを確認します。
- **実行（通常VACUUM）**: `VACUUM ANALYZE テーブル名;` を実行します。
  - 再度サイズを確認します。**サイズ自体は小さくならない**（再利用可能になるだけ）ことに注目してください。
- **実行（FULL）**: `VACUUM FULL テーブル名;` を実行します。
  - 再度サイズを確認します。OSに領域が返却され、ファイルサイズが劇的に小さくなるはずです。

---

## 運用管理のチェックポイント一覧表

演習中に意識すべき、試験に出やすいポイントをまとめました。

| 項目 | 確認すべきコマンド/ファイル | 試験のひっかけポイント |
| --- | --- | --- |
| **物理バックアップ** | `pg_basebackup` | 実行中にDBを止める必要はない（オンライン可） |
| **論理バックアップ** | `pg_dump` | 特定のDBのみ。リストアは `psql` か `pg_restore` |
| **設定反映** | `pg_ctl reload` | `postgresql.conf` の一部は再起動(`restart`)が必要 |
| **権限確認** | `\z` (psqlメタコマンド) | 誰が何の権限（r/w/a/d）を持っているか |
| **統計情報** | `ANALYZE` | 実行しないと実行計画が古くなり、クエリが遅くなる |
